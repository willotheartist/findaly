// prisma/schema.prisma
generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
}

/**
 * ─────────────────────────────────────────────────────────────
 * Enums
 * ─────────────────────────────────────────────────────────────
 */

enum AccountType {
  PRIVATE
  BROKER
  DEALER
  SHIPYARD
  SERVICE_PRO
  CREW
  EMPLOYER
}

enum UserRole {
  USER
  ADMIN
}

enum ListingKind {
  VESSEL
  PARTS
  SERVICES
  JOBS
}

enum ListingIntent {
  SALE
  CHARTER
}

enum ListingStatus {
  DRAFT
  LIVE
  PAUSED
  SOLD
}

enum Currency {
  EUR
  GBP
  USD
  AED
  OTHER
}

enum VesselCondition {
  NEW
  USED
}

enum SellerType {
  PRIVATE
  PROFESSIONAL
}

enum PriceType {
  FIXED
  NEGOTIABLE
  POA
  AUCTION
}

enum CharterPricePeriod {
  HOUR
  DAY
  WEEK
}

enum PartsCondition {
  NEW
  USED
  REFURBISHED
}

/**
 * ─────────────────────────────────────────────────────────────
 * Monetization enums
 * ─────────────────────────────────────────────────────────────
 */

enum ProductKey {
  FEATURED_LISTING_14D
  FEATURED_LISTING_30D

  BOOST_7D
  BOOST_14D

  FINANCE_PRIORITY_14D
  FINANCE_PRIORITY_30D

  BROKER_PRO_MONTHLY
  VERIFIED_BROKER_MONTHLY
}

enum PaymentProvider {
  KOMPIPAY
}

enum PaymentStatus {
  PENDING
  PAID
  FAILED
  CANCELED
}

enum BrokerPlan {
  FREE
  PRO
}

/**
 * ─────────────────────────────────────────────────────────────
 * Models
 * ─────────────────────────────────────────────────────────────
 */

model User {
  id        String   @id @default(cuid())
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  role UserRole @default(USER)

  email        String      @unique
  passwordHash String
  accountType  AccountType @default(PRIVATE)

  profiles     Profile[]
  sessions     Session[]
  messagesSent Message[] @relation("Sent")
  messagesRecv Message[] @relation("Recv")

  savedSearches  SavedSearch[]
  paymentIntents PaymentIntent[]
}

model Session {
  id        String   @id @default(cuid())
  createdAt DateTime @default(now())
  expiresAt DateTime
  token     String   @unique

  userId String
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([expiresAt])
}

model Profile {
  id        String   @id @default(cuid())
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  userId String
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  slug String @unique

  name     String
  tagline  String?
  location String?
  about    String?

  website String?
  email   String?
  phone   String?

  avatarUrl      String?
  companyLogoUrl String?

  isVerified Boolean @default(false)

  /**
   * ───────── Monetization fields ─────────
   */
  brokerPlan             BrokerPlan @default(FREE)
  brokerProActiveUntil   DateTime?
  verifiedUntil          DateTime?
  kompipayCustomerId     String?
  kompipaySubscriptionId String?

  listings Listing[]

  @@index([userId])
  @@index([slug])
}

model Listing {
  id        String   @id @default(cuid())
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  kind   ListingKind   @default(VESSEL)
  intent ListingIntent @default(SALE)
  status ListingStatus @default(DRAFT)

  title       String
  slug        String  @unique
  description String?

  // Location
  location String?
  country  String?
  marina   String?
  lying    String?

  // Pricing
  currency   Currency  @default(EUR)
  priceCents Int?
  priceType  PriceType @default(NEGOTIABLE)
  priceNote  String?
  taxStatus  String?

  // Listing options
  featured     Boolean @default(false)
  urgent       Boolean @default(false)
  acceptOffers Boolean @default(true)

  /**
   * ───────── Monetization fields ─────────
   */
  featuredUntil        DateTime?
  boostLevel           Int       @default(0)
  boostUntil           DateTime?
  financePriority      Boolean   @default(false)
  financePriorityUntil DateTime?

  // VESSEL SPECIFIC
  boatCategory    String?
  charterType     String?
  vesselCondition VesselCondition?

  brand String?
  model String?
  year  Int?

  lengthFt     Float?
  lengthM      Float?
  beamFt       Float?
  beamM        Float?
  draftFt      Float?
  draftM       Float?
  displacement String?

  hullMaterial String?
  hullType     String?
  hullColor    String?

  engineMake   String?
  engineModel  String?
  enginePower  String?
  engineCount  Int?
  engineHours  Int?
  fuelType     String?
  fuelCapacity String?

  cabins Int?
  berths Int?
  heads  Int?

  features        Json    @default("[]")
  electronics     Json    @default("[]")
  safetyEquipment Json    @default("[]")
  customFeatures  String?

  charterGuests        Int?
  charterCrew          Int?
  charterPricePeriod   CharterPricePeriod?
  charterAvailableFrom DateTime?
  charterAvailableTo   DateTime?
  charterIncluded      Json                @default("[]")

  recentWorks String?

  videoUrl       String?
  virtualTourUrl String?

  // SERVICES SPECIFIC
  serviceCategory    String?
  serviceName        String?
  serviceDescription String?
  serviceExperience  String?
  serviceAreas       Json    @default("[]")

  // PARTS SPECIFIC
  partsCategory      String?
  partsCondition     PartsCondition?
  partsCompatibility String?

  // SELLER INFO
  sellerType     SellerType @default(PRIVATE)
  sellerName     String?
  sellerCompany  String?
  sellerEmail    String?
  sellerPhone    String?
  sellerWhatsapp Boolean    @default(false)
  sellerLocation String?
  sellerWebsite  String?

  // Relations
  profileId String
  profile   Profile @relation(fields: [profileId], references: [id], onDelete: Cascade)

  media          ListingMedia[]
  conversations  Conversation[]
  paymentIntents PaymentIntent[]

  @@index([profileId])
  @@index([kind, intent, status])
  @@index([boatCategory])
  @@index([country])
  @@index([priceCents])
  @@index([year])
  @@index([lengthM])
}

model ListingMedia {
  id        String   @id @default(cuid())
  createdAt DateTime @default(now())

  listingId String
  listing   Listing @relation(fields: [listingId], references: [id], onDelete: Cascade)

  url  String
  sort Int    @default(0)

  @@index([listingId, sort])
}

model Conversation {
  id        String   @id @default(cuid())
  createdAt DateTime @default(now())

  listingId String?
  listing   Listing? @relation(fields: [listingId], references: [id], onDelete: SetNull)

  messages Message[]

  @@index([listingId])
}

model Message {
  id        String   @id @default(cuid())
  createdAt DateTime @default(now())

  conversationId String
  conversation   Conversation @relation(fields: [conversationId], references: [id], onDelete: Cascade)

  senderId String
  sender   User   @relation("Sent", fields: [senderId], references: [id], onDelete: Cascade)

  receiverId String
  receiver   User   @relation("Recv", fields: [receiverId], references: [id], onDelete: Cascade)

  body String

  @@index([conversationId, createdAt])
  @@index([senderId, createdAt])
  @@index([receiverId, createdAt])
}

model SavedSearch {
  id         String    @id @default(cuid())
  createdAt  DateTime  @default(now())
  updatedAt  DateTime  @updatedAt
  lastUsedAt DateTime?

  userId String
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  name      String
  kind      String @default("BUY")
  query     Json
  replayUrl String

  @@index([userId, createdAt])
  @@index([kind])
}

/**
 * ─────────────────────────────────────────────────────────────
 * PaymentIntent (idempotency + audit)
 * ─────────────────────────────────────────────────────────────
 */

model PaymentIntent {
  id        String   @id @default(cuid())
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  provider PaymentProvider @default(KOMPIPAY)
  status   PaymentStatus   @default(PENDING)

  productKey ProductKey

  userId String
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  listingId String?
  listing   Listing? @relation(fields: [listingId], references: [id], onDelete: SetNull)

  quantity Int @default(1)

  kompipaySessionId  String? @unique
  kompipayEventId    String?
  kompipaySubId      String?
  kompipayCustomerId String?

  appliedAt DateTime?

  metadata Json @default("{}")

  @@index([userId, createdAt])
  @@index([status])
  @@index([productKey])
  @@index([listingId])
}
